<!DOCTYPE html>
<html>
<head>
    <title>Hexmash</title>
    <style type="text/css">
        body {
            font-family: sans-serif;
        }

        #site {
            width: 785px;
            margin: 0 auto;
        }

        #toolbar {
            height: 60px;
            padding: 0 20px;
            
            background: #fff;
            border: 2px solid #d9d9d9;
            box-shadow: 0px 2px 4px 0px rgba(0,0,0,0.12);
            border-radius: 5px;

            color: #666;
            line-height: 60px;

            vertical-align: middle;
        }

        #toolbar #file_info {
            float: left;
        }

        #toolbar #tool_open {
            float: right;
            
            width: 26px;
            height: 31px;
            margin: 14px 0;
            
            background-image: url('images/drop_icon_tool.png');

            cursor: pointer;
        }

        #dropzone {
            height: 265px;
            margin-top:25px;

            overflow: hidden;
            
            background-color: #fafafa;
            border: 4px dashed #e9e9e9;
            border-radius: 10px;

            color: #aaa;
            font-size: 12px;
            text-align: center;
            vertical-align: middle;

            transition:         height 0.75s;
            -moz-transition:    height 0.75s;
            -webkit-transition: height 0.75s;
            -o-transition:      height 0.75s;
        }

        #dropzone.collapsed {
            height: 0px;
        }

        #dropzone div {
            margin-top: 10px;
        }

        #dropzone #drop_icon {
            width: 100px;
            height: 118px;
            margin: 25px auto;

            background-image: url('images/drop_icon.png');
        }

        #dropzone #drop_text {
            font-size: 16px;
        }

        #dropzone #browse {
            color: #00f;
            cursor: pointer;
        }

        #dropzone #browse:hover {
            text-decoration: underline;
        }

        #content {
            font-family: monospace;
            margin-top:25px;
        }

        #offset {
            width: 110px;
            background-color: #eee;

            text-align: center;
        }

        #hex {
            width: 400px;
        }

        #hex_value {
            padding: 0 12px;
        }

        #raw {
            width: 275px;
        }

        #raw_value {
            padding: 0 12px;
        }

        .file_info {
            color:#5F0FB1;
            font-family: monospace;
        }

        .header {
            padding-bottom: 10px;

            background-color: #fff;

            color: #5F0FB1;
            text-align: center;
        }

        .column {
            float: left;
        }
    </style>
</head>
<body>
    <div id="site">
        <div id="toolbar">
            <div id="file_info">
                File: <span id="file_name" class="file_info">None</span>
                Size: <span id="file_size" class="file_info">0</span> 
                <span class="file_info">B</span>
            </div>
            <div id="file_controls">
                <div id="tool_open"></div>
            </div>
        </div>

        <div id="dropzone">
            <div id="drop_icon"></div>
            <div>
                <div id="drop_text">Drag and Drop Your File Here</div>
                <div>or</div>
                <div id="browse">Browse For File on Your Computer</div>
                <input id="file_browse" type="file" style="display:none"/>
            </div>
        </div>

        <div id="content">
            <div id="offset" class="column">
                <div class="header">Offset</div>
                <div id="offset_value">
                </div>
            </div>
            <div id="hex" class="column">
                <div class="header">00 01 02 03 04 05 06 07&nbsp;&nbsp;08 09 0A 0B 0C 0D 0E 0F</div>
                <div id="hex_value">
                </div>
            </div>
            <div id="raw" class="column">
                <div class="header">RAW</div>
                <div id="raw_value"></div>
            </div>
        </div>

        <div style="clear:both"></div>
    </div>
</body>
<script type="text/javascript">

    // Toolbar elements
    var filenameDiv = document.getElementById('file_name');
    var filesizeDiv = document.getElementById('file_size');
    var openTool = document.getElementById('tool_open');

    // File loading elements
    var fileBrowser = document.getElementById('file_browse');
    var targetDiv = document.getElementById('dropzone');

    // Viwer elements
    var offsetValue = document.getElementById('offset_value');
    var hexValue = document.getElementById('hex_value');
    var rawValue = document.getElementById('raw_value');

    // Hookup tools
    openTool.addEventListener("click", showHideDropzone, false);

    // Hookup drag and drop
    makeDropable(targetDiv);
    makeDropable(openTool);

    // Hookup the browser and  link using the hidden file browser
    fileBrowser.addEventListener("change", onFileChange, false);
    document.getElementById('browse').addEventListener("click", function() {
        fileBrowser.click();
    }, false);

    // Setup the reader
    var reader = new FileReader()

    /*
    * File reader progress event
    */
    reader.onprogress = function (evt) {
        var progress = evt.loaded / evt.total;
        // TODO: Show progress
        console.log(progress);
    }

    /*
    * File reader load event - this is where the core of the loading into the 
    * viewer is handled
    */
    reader.onload  = function (evt) {
        var resultBuffer = evt.target.result;

        var bytes = new Uint8Array(resultBuffer);

        var offsetHolder = document.createDocumentFragment();
        var hexHolder = document.createDocumentFragment();
        var rawHolder = document.createDocumentFragment();

        var byteCount = bytes.length;
        for (var b=0; b<byteCount; b++)
        {
            if (b % 16 == 0)
            {
                // Add a new row to each section every 16 bytes
                var offsetBreak = document.createElement("br");
                offsetHolder.appendChild(offsetBreak);
                var offset = String(b);
                while (offset.length < 9) {
                    if (offset.length == 4) {
                        offset = " " + offset;
                    }
                    offset = "0" + offset;
                }
                var offsetSpan = document.createElement("span");
                offsetSpan.innerHTML = offset;
                offsetHolder.appendChild(offsetSpan);


                var hexBreak = document.createElement("br");
                hexHolder.appendChild(hexBreak);

                var rawBreak = document.createElement("br");
                rawHolder.appendChild(rawBreak);
            }
            else if (b % 8 == 0)
            {
                // Add a double space to the hex and raw half way through each row (8 bytes)
                var secondSpacer = document.createElement("span");
                secondSpacer.innerHTML = "&nbsp;&nbsp;"
                hexHolder.appendChild(secondSpacer);

                var rawSpacer = document.createElement("span");
                rawSpacer.innerHTML = "&nbsp;&nbsp;"
                rawHolder.appendChild(rawSpacer);
            }
            else {
                // Add a simple spacer when not adding a new row or double space
                var hexSpacer = document.createElement("span");
                hexSpacer.innerHTML = "&nbsp;"
                hexHolder.appendChild(hexSpacer);

                var rawSpacer = document.createElement("span");
                rawSpacer.innerHTML = "&nbsp;"
                rawHolder.appendChild(rawSpacer);
            }

            // Append hex
            var hexSpan = document.createElement("span");
            var hex = bytes[b].toString(16);
            if (hex.length == 1)
            {
                hex = "0" + hex;
            }
            hexSpan.innerHTML = hex;
            hexHolder.appendChild(hexSpan);

            // Append text
            var rawSpan = document.createElement("span");
            var text = String.fromCharCode(bytes[b]);
            // Only include displayable characters
            if (bytes[b] < 32 || bytes[b] > 126)
            {
                text = ".";
            }
            rawSpan.innerHTML = text;
            rawHolder.appendChild(rawSpan);
        }

        // Append the fragments to their respective divs
        document.getElementById('offset_value').appendChild(offsetHolder);
        document.getElementById('hex_value').appendChild(hexHolder);
        document.getElementById('raw_value').appendChild(rawHolder);
    }
    

    /*
    * File browser change event, currently only load the first file selected
    */
    function onFileChange(evt) {
        var files = evt.target.files;
        var fileCount = files.length;

        // TODO: List files for seletion, for now only handle the last (Assume 1)
        if (fileCount > 0) {
            loadFile(files[0]);
        }   
    }
    
    /*
    * Drop event that get's the files passed in, currently only loads the first file
    */
    function onDrop(evt) {
        var files = evt.dataTransfer.files;
        var fileCount = files.length;

        // TODO: List files for seletion, for now only handle the last (Assume 1)
        if (fileCount > 0) {
            loadFile(files[0]);
        }

        // Prevent the browser from loading the file into the window
        preventDefault(evt);
    }

    /*
    * Helper function to prevent default browser action and stop propagation
    */
    function preventDefault(evt) {
        evt.stopPropagation();
        evt.preventDefault();
    }

    /**
    * Helper function to make element dropable - both the tool icon and the drop zone can
    * have files dropped on them
    */
    function makeDropable(element) {
        element.addEventListener("dragenter", preventDefault, false);
        element.addEventListener("dragexit", preventDefault, false);
        element.addEventListener("dragover", preventDefault, false);
        element.addEventListener("drop", onDrop, false);
    }

    /**
    * Collapse/expand the dropzone
    */
    function showHideDropzone(evt) {
        if (targetDiv.classList.contains('collapsed')) {
            targetDiv.classList.remove('collapsed');
        }
        else {
            targetDiv.classList.add('collapsed');
        }
        
    }

    /**
    * Initiate the loading of a file 
    */
    function loadFile(file) {
        targetDiv.classList.add('collapsed');

        offsetValue.innerHTML = "";
        hexValue.innerHTML = "";
        rawValue.innerHTML = "";

        filenameDiv.innerHTML = file.name;
        filesizeDiv.innerHTML = file.size;
        console.log("loading: " + file.name)

        reader.readAsArrayBuffer(file);
    }
</script>
</html>